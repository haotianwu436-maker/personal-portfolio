# Cursor 行为规则和项目规范

本文件定义了Cursor在此项目中应遵循的行为规则、代码规范和开发流程。Cursor应该在执行任何任务前阅读此文件。

## 🎯 项目基本信息

**项目名称**：Personal Portfolio（个人作品集网站）

**技术栈**：
- 前端：React 19 + TypeScript + Vite + Tailwind CSS 4
- 后端：Express.js + tRPC + MySQL
- ORM：Drizzle ORM
- 测试：Vitest + React Testing Library
- 部署：Manus平台

**设计风格**：Quiet Narrative（极简美学）
- 背景色：米色 `#f5f1e8`
- 文字色：深灰色 `#2c2c2c`
- 强调色：森林绿 `#2d5016`

**网站地址**：https://persfolio-iet8jqpk.manus.space/

---

## 📋 行为规则

### 1. 接收任务时

当用户给你发送功能需求时，你应该：

1. **理解需求**：仔细阅读用户的需求描述，如果不清楚就询问
2. **查看模板**：检查是否有合适的模板可以使用（FEATURE_REQUEST_TEMPLATES.md）
3. **确认计划**：向用户说明你的实现计划，包括涉及的文件和步骤
4. **开始实现**：按照本文件的规范进行开发

### 2. 开发过程中

**必须遵循的步骤**：

1. **更新todo.md** - 在开始任何开发前，添加新任务到todo.md
2. **遵循代码规范** - 所有代码必须符合项目的代码风格
3. **编写测试** - API功能必须有单元测试，UI组件应有测试
4. **运行验证** - 开发完成后必须运行所有检查
5. **更新文档** - 如果添加了新功能，更新相关文档

**禁止的行为**：

- ❌ 跳过测试直接提交代码
- ❌ 使用 `any` 类型
- ❌ 修改项目的核心配置（如tsconfig.json）而不通知用户
- ❌ 删除现有的功能或文件
- ❌ 不更新todo.md就开始开发

### 3. 完成任务时

任务完成后，你必须：

1. **确认所有测试通过** - 运行 `pnpm test`，所有28项测试必须通过
2. **确认构建成功** - 运行 `pnpm build`，没有错误
3. **更新todo.md** - 将完成的任务标记为 [x]
4. **提交代码** - 使用 `git add .` 和 `git commit -m "..."` 提交
5. **运行部署脚本** - 执行 `./scripts/auto-deploy.sh`
6. **报告完成** - 向用户报告完成情况，包括Checkpoint版本号

---

## 💻 代码规范

### TypeScript规范

**必须**：
- 使用TypeScript，避免使用 `any` 类型
- 为所有函数参数和返回值添加类型注解
- 使用 `interface` 或 `type` 定义数据结构
- 导入时使用绝对路径（从 `@/` 开始）

**示例**：
```typescript
// ✅ 正确
interface Article {
  id: string;
  title: string;
  content: string;
}

export async function getArticle(id: string): Promise<Article> {
  // ...
}

// ❌ 错误
export async function getArticle(id: any): any {
  // ...
}
```

### React组件规范

**必须**：
- 使用函数式组件和Hooks
- 组件文件名使用PascalCase（如 `ArticleCard.tsx`）
- 导出默认组件
- 添加组件的TypeScript类型

**示例**：
```typescript
// ✅ 正确
interface ArticleCardProps {
  title: string;
  excerpt: string;
  date: Date;
}

export default function ArticleCard({
  title,
  excerpt,
  date,
}: ArticleCardProps) {
  return (
    <div className="article-card">
      {/* ... */}
    </div>
  );
}

// ❌ 错误
export default function articleCard(props: any) {
  // ...
}
```

### Tailwind CSS规范

**必须**：
- 使用Tailwind CSS进行样式设计
- 遵循项目的色彩系统（米色、深灰色、森林绿）
- 使用响应式类名（`md:`、`lg:` 等）
- 避免使用内联样式

**示例**：
```typescript
// ✅ 正确
<button className="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800 md:px-6">
  Click me
</button>

// ❌ 错误
<button style={{ backgroundColor: '#2d5016', color: 'white' }}>
  Click me
</button>
```

### API端点规范

**必须**：
- 使用tRPC定义API端点
- 使用Zod验证输入参数
- 添加错误处理
- 为API端点编写单元测试

**示例**：
```typescript
// ✅ 正确
export const appRouter = router({
  articles: router({
    list: publicProcedure.query(async () => {
      return db.getArticles();
    }),
    create: protectedProcedure
      .input(z.object({
        title: z.string(),
        content: z.string(),
      }))
      .mutation(async ({ input, ctx }) => {
        if (ctx.user.openId !== ENV.ownerOpenId) {
          throw new Error("Unauthorized");
        }
        return db.createArticle(input);
      }),
  }),
});
```

### 数据库规范

**必须**：
- 在 `drizzle/schema.ts` 中定义表
- 在 `server/db.ts` 中创建查询函数
- 使用 `pnpm db:push` 应用迁移
- 为每个表添加 `id` 主键和 `createdAt` 时间戳

**示例**：
```typescript
// ✅ 正确
export const articles = createTable("articles", (t) => ({
  id: t.text("id").primaryKey().$defaultFn(() => nanoid()),
  title: t.text("title").notNull(),
  content: t.text("content").notNull(),
  createdAt: t.timestamp("created_at").defaultNow(),
}));

// 在server/db.ts中
export async function createArticle(data: {
  title: string;
  content: string;
}) {
  return db.insert(articles).values(data);
}
```

### 测试规范

**必须**：
- 为API端点编写单元测试
- 测试文件放在 `server/` 目录中，文件名为 `*.test.ts`
- 使用Vitest框架
- 测试应该覆盖正常情况和错误情况

**示例**：
```typescript
// ✅ 正确
import { describe, it, expect } from "vitest";
import { appRouter } from "./routers";

describe("articles router", () => {
  it("should list all articles", async () => {
    const result = await appRouter.createCaller({}).articles.list();
    expect(Array.isArray(result)).toBe(true);
  });

  it("should create article when authenticated", async () => {
    const result = await appRouter.createCaller({
      user: { openId: "test@example.com" },
    }).articles.create({
      title: "Test",
      content: "Test content",
    });
    expect(result.id).toBeDefined();
  });
});
```

---

## 📁 文件组织规范

### 前端文件结构

```
client/src/
├── pages/              # 页面组件
│   ├── Home.tsx
│   ├── Blog.tsx
│   └── [PageName].tsx
├── components/         # UI组件
│   ├── ArticleCard.tsx
│   ├── [ComponentName].tsx
│   └── ui/            # shadcn/ui组件
├── _core/             # 核心功能
│   ├── hooks/         # 自定义Hooks
│   ├── context.ts     # 上下文
│   └── env.ts         # 环境变量
├── lib/               # 工具函数
│   ├── trpc.ts        # tRPC客户端
│   └── utils.ts       # 工具函数
├── App.tsx            # 主应用组件
├── index.css          # 全局样式
└── main.tsx           # 入口文件
```

### 后端文件结构

```
server/
├── routers.ts         # tRPC路由定义
├── db.ts              # 数据库查询函数
├── storage.ts         # S3文件存储
├── _core/             # 核心功能
│   ├── context.ts     # 认证上下文
│   ├── env.ts         # 环境变量
│   └── llm.ts         # LLM集成
├── *.test.ts          # 单元测试
└── index.ts           # 服务器入口
```

---

## 🧪 测试要求

### 测试覆盖率目标

- **整体覆盖率**：≥ 80%
- **API端点覆盖率**：100%（所有API都必须有测试）
- **核心业务逻辑覆盖率**：≥ 90%

### 运行测试

```bash
# 运行所有测试
pnpm test

# 运行特定测试文件
pnpm test server/articles.test.ts

# 查看覆盖率报告
pnpm test -- --coverage
```

### 测试必须通过的条件

- 所有28项测试必须通过（✓）
- 没有TypeScript错误
- 没有ESLint警告
- 覆盖率不能下降

---

## 🚀 部署流程

### 完整的部署步骤

1. **更新todo.md** - 添加新任务
2. **开发功能** - 编写代码和测试
3. **运行验证**：
   ```bash
   pnpm test        # 所有测试必须通过
   pnpm check       # TypeScript检查
   pnpm build       # 构建项目
   ```
4. **提交代码**：
   ```bash
   git add .
   git commit -m "feat: description"
   git push github main
   ```
5. **运行部署脚本**：
   ```bash
   ./scripts/auto-deploy.sh "commit message"
   ```
6. **报告完成** - 向用户提供Checkpoint版本号

### 部署脚本的作用

`./scripts/auto-deploy.sh` 会自动：
- 运行所有测试
- 检查TypeScript
- 构建项目
- 创建备份
- 失败时自动回滚

---

## 📚 重要文档

Cursor应该熟悉这些文档：

| 文档 | 用途 |
|------|------|
| CURSOR_AUTO_DEPLOY.md | 详细的自动化部署流程 |
| CURSOR_QUICK_START.md | 快速参考指南 |
| FEATURE_REQUEST_TEMPLATES.md | 功能需求模板 |
| CURSOR_WORKFLOW.md | 项目架构和规范 |
| DEPLOYMENT_GUIDE.md | 部署指南 |
| FEATURE_ROADMAP.md | 功能开发计划 |

---

## 🔐 安全和权限

### 编辑权限

- **编辑密码**：`admin123`（位置：`client/src/_core/hooks/useEditPassword.ts`）
- **所有编辑操作**都需要输入密码
- **不要在代码中硬编码密码**，使用环境变量

### 敏感信息

- **不要提交API密钥**到GitHub
- **不要提交数据库凭证**到代码中
- **使用环境变量**存储敏感信息
- **检查.gitignore**确保敏感文件被忽略

---

## ⚠️ 常见错误

**不要做这些事**：

1. ❌ 跳过测试直接提交代码
2. ❌ 使用 `any` 类型
3. ❌ 修改项目配置而不通知用户
4. ❌ 删除现有功能
5. ❌ 不更新todo.md就开始开发
6. ❌ 提交包含敏感信息的代码
7. ❌ 使用内联样式而不是Tailwind CSS
8. ❌ 不为API端点编写测试
9. ❌ 忽略TypeScript错误
10. ❌ 不运行 `pnpm build` 就认为完成了

---

## 📞 遇到问题时

如果遇到问题，按照这个顺序：

1. **查看错误信息** - 仔细阅读错误信息
2. **查看日志** - 检查 `deploy-*.log` 文件
3. **查看文档** - 查看相关的文档
4. **询问用户** - 如果还是不明白，询问用户

---

## 🎯 成功标志

完成一个功能后，你应该看到：

✅ 所有28项测试通过
✅ TypeScript编译无错误
✅ 项目构建成功
✅ 代码推送到GitHub
✅ Checkpoint已创建
✅ 网站已发布
✅ 新功能在网站上可见

---

**现在你已经了解了所有的规则和规范。开始接收用户指令吧！** 🚀
