name: Deploy to Manus

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: [ "Test and Build" ]
    types: [ completed ]
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run tests
      run: pnpm test

    - name: Build project
      run: pnpm build

    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Deployment Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Project built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to [Manus Management UI](https://manus.space)" >> $GITHUB_STEP_SUMMARY
        echo "2. Navigate to your project dashboard" >> $GITHUB_STEP_SUMMARY
        echo "3. Click the **Publish** button to deploy the latest changes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

    - name: Comment on commit
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.git.createCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            message: 'âœ… Tests passed - Ready for deployment',
            tree: context.payload.after,
            parents: [context.payload.before]
          }).catch(() => {
            console.log('Commit already exists or other issue');
          });
