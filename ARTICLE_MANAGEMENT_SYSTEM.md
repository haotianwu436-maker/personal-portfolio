# 文章管理系统设计文档

本文档描述个人作品集网站的完整文章管理系统架构。该系统只允许网站所有者创建、编辑和删除文章。

## 系统概览

### 核心特性

**权限控制**：只有网站所有者（通过OAuth认证）可以访问文章管理功能

**文章管理**：
- 创建新文章（支持草稿和发布状态）
- 编辑现有文章
- 删除文章
- 管理文章标签
- 支持Markdown编辑

**用户界面**：
- 文章管理后台（仅所有者可见）
- 文章创建表单
- 文章编辑表单
- 文章列表视图

## 架构设计

### 前端架构

```
┌─────────────────────────────────────────────────────────────┐
│ 公开页面                                                     │
├─────────────────────────────────────────────────────────────┤
│ Home.tsx          - 首页（展示最新文章）                     │
│ ArticleList.tsx   - 文章列表页                               │
│ ArticleDetail.tsx - 文章详情页                               │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 受保护页面（需要所有者登录）                                 │
├─────────────────────────────────────────────────────────────┤
│ AdminDashboard.tsx      - 管理后台首页                       │
│ ArticleManagement.tsx   - 文章管理列表                       │
│ ArticleCreate.tsx       - 创建文章                           │
│ ArticleEdit.tsx         - 编辑文章（修复现有）               │
└─────────────────────────────────────────────────────────────┘
```

### 后端架构

```
┌─────────────────────────────────────────────────────────────┐
│ 数据库层 (Drizzle ORM)                                       │
├─────────────────────────────────────────────────────────────┤
│ articles表                                                   │
│ ├─ id (主键)                                                 │
│ ├─ title (标题)                                              │
│ ├─ slug (URL slug)                                           │
│ ├─ excerpt (摘要)                                            │
│ ├─ content (Markdown内容)                                    │
│ ├─ tags (JSON数组)                                           │
│ ├─ status (draft/published)                                  │
│ ├─ authorId (作者ID)                                         │
│ ├─ publishedAt (发布时间)                                    │
│ ├─ createdAt (创建时间)                                      │
│ └─ updatedAt (更新时间)                                      │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 业务逻辑层 (server/db.ts)                                    │
├─────────────────────────────────────────────────────────────┤
│ getAllPublishedArticles()   - 获取所有已发布文章             │
│ getAllArticles()            - 获取所有文章（含草稿）         │
│ getArticleById()            - 获取单篇文章                   │
│ getArticleBySlug()          - 按slug获取文章                 │
│ createArticle()             - 创建文章                       │
│ updateArticle()             - 更新文章                       │
│ deleteArticle()             - 删除文章                       │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ API层 (server/routers.ts)                                    │
├─────────────────────────────────────────────────────────────┤
│ articles.list              - 获取已发布文章列表（公开）      │
│ articles.getBySlug         - 获取文章详情（公开）            │
│ articles.getById           - 获取文章（含草稿，需认证）      │
│ articles.getAllDrafts      - 获取所有草稿（需所有者认证）    │
│ articles.create            - 创建文章（需所有者认证）        │
│ articles.update            - 更新文章（需所有者认证）        │
│ articles.delete            - 删除文章（需所有者认证）        │
│ articles.publish           - 发布文章（需所有者认证）        │
│ articles.unpublish         - 取消发布（需所有者认证）        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 认证层 (server/_core/context.ts)                             │
├─────────────────────────────────────────────────────────────┤
│ ctx.user                   - 当前用户信息                    │
│ ctx.user.openId            - 用户OAuth ID                    │
│ ENV.ownerOpenId            - 所有者OAuth ID                  │
│ 权限检查: ctx.user?.openId === ENV.ownerOpenId              │
└─────────────────────────────────────────────────────────────┘
```

## 权限控制

### 权限矩阵

| 操作 | 未登录 | 登录用户 | 所有者 |
|------|--------|---------|--------|
| 查看已发布文章 | ✅ | ✅ | ✅ |
| 查看草稿文章 | ❌ | ❌ | ✅ |
| 创建文章 | ❌ | ❌ | ✅ |
| 编辑文章 | ❌ | ❌ | ✅ |
| 删除文章 | ❌ | ❌ | ✅ |
| 发布/取消发布 | ❌ | ❌ | ✅ |
| 访问管理后台 | ❌ | ❌ | ✅ |

### 权限检查流程

```
用户请求
    │
    ▼
是否需要认证？
    │
    ├─ 否 → 直接处理（公开API）
    │
    └─ 是 → 检查ctx.user
            │
            ├─ 未登录 → 返回401错误
            │
            └─ 已登录 → 检查是否为所有者
                        │
                        ├─ 不是所有者 → 返回403错误
                        │
                        └─ 是所有者 → 处理请求
```

## 数据流

### 创建文章流程

```
1. 用户访问 /admin/articles/create
   ↓
2. 检查用户是否登录
   - 未登录 → 重定向到登录页
   - 已登录 → 继续
   ↓
3. 检查用户是否为所有者
   - 不是 → 显示权限错误
   - 是 → 显示创建表单
   ↓
4. 用户填写表单（标题、内容、标签等）
   ↓
5. 用户点击"保存"或"发布"
   ↓
6. 前端调用 articles.create API
   ↓
7. 后端验证权限和数据
   ↓
8. 保存到数据库
   ↓
9. 返回成功响应
   ↓
10. 前端重定向到文章详情页
```

### 编辑文章流程

```
1. 用户访问 /admin/articles/{id}/edit
   ↓
2. 检查用户是否登录且为所有者
   ↓
3. 加载文章数据
   ↓
4. 显示编辑表单（预填充现有数据）
   ↓
5. 用户修改内容
   ↓
6. 用户点击"保存"
   ↓
7. 前端调用 articles.update API
   ↓
8. 后端验证权限和数据
   ↓
9. 更新数据库
   ↓
10. 返回成功响应
    ↓
11. 前端重定向到文章详情页
```

## 实现清单

### 后端实现

- [x] 数据库schema（articles表）
- [x] 数据库查询函数（db.ts）
- [x] API路由（routers.ts）
- [x] 权限检查逻辑
- [ ] 新增API：articles.getAllDrafts（获取所有草稿）
- [ ] 新增API：articles.publish（发布文章）
- [ ] 新增API：articles.unpublish（取消发布）

### 前端实现

- [x] 文章详情页（ArticleDetail.tsx）
- [x] 文章编辑页（ArticleEdit.tsx - 需要修复）
- [ ] 修复：添加登录检查
- [ ] 修复：添加所有者检查
- [ ] 新增：管理后台首页（AdminDashboard.tsx）
- [ ] 新增：文章管理列表（ArticleManagement.tsx）
- [ ] 新增：文章创建页（ArticleCreate.tsx）
- [ ] 新增：受保护路由中间件

### 测试实现

- [ ] 权限检查测试
- [ ] 文章创建测试
- [ ] 文章编辑测试
- [ ] 文章删除测试
- [ ] 草稿/发布状态测试

## 常见问题

### Q: 为什么我无法编辑文章？

**A**: 可能的原因：
1. 你没有登录 - 需要使用OAuth登录
2. 你登录的账户不是网站所有者 - 只有所有者可以编辑
3. 浏览器缓存 - 清除缓存后重试
4. 网络连接问题 - 检查网络连接

### Q: 如何创建新文章？

**A**: 
1. 确保你已登录（作为所有者）
2. 访问 `/admin/articles/create`
3. 填写文章表单
4. 选择状态（草稿或发布）
5. 点击"保存"或"发布"

### Q: 草稿和已发布有什么区别？

**A**:
- **草稿**：只有所有者可以看到，不会在首页或文章列表中显示
- **已发布**：所有人都可以看到，会在首页和文章列表中显示

### Q: 如何发布草稿？

**A**: 
1. 进入草稿文章的编辑页面
2. 将状态改为"已发布"
3. 点击"保存更改"

## 安全考虑

### 前端安全

- 所有编辑按钮都检查用户权限
- 受保护路由只在用户是所有者时显示
- 敏感操作（删除）需要确认

### 后端安全

- 所有修改操作都检查 `ctx.user.openId === ENV.ownerOpenId`
- 数据验证使用Zod schema
- 错误消息不泄露敏感信息
- 所有操作都有日志记录

### 数据保护

- 草稿文章不会通过公开API返回
- 删除操作无法撤销（需要谨慎）
- 所有更改都记录创建/更新时间

## 性能优化

### 缓存策略

- 已发布文章列表可以缓存
- 单篇文章可以缓存
- 草稿文章不缓存（实时更新）

### 数据库优化

- 为slug字段添加索引（快速查询）
- 为status字段添加索引（快速筛选）
- 为authorId字段添加索引（快速查询作者文章）

## 未来扩展

### 可能的功能

1. **文章分类**：为文章添加分类功能
2. **文章搜索**：全文搜索文章内容
3. **文章评论**：允许访客评论文章
4. **阅读统计**：追踪文章浏览量
5. **文章版本控制**：保存文章编辑历史
6. **计划发布**：设置文章在未来某个时间发布
7. **文章预览**：发布前预览文章效果

---

**记住**：这个系统的设计目标是简单、安全和易于维护。所有权限检查都在前后端进行双重验证，确保只有你才能修改内容。
